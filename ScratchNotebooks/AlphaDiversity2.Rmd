---
title: "R Notebook"
output: html_notebook
---
Everything but richness

```{r}
library(breakaway)
library(DivNet)
#library(phyloseq)
library(speedyseq)
source("InitialProcessing.R")
source("ChesapeakePersonalLibrary.R")
```


```{r}
otuTable <- nonSpikes %>% select(ID, ASV, reads) %>% pivot_wider(names_from = ASV, values_from = reads, id_cols = ID)
```


```{r}
otuMatrix <- otuTable %>% column_to_rownames(var = "ID") %>% as.matrix %>% t()
```

```{r}
otuPhyseq <- otu_table(otuMatrix, taxa_are_rows = TRUE)
```

```{r}
sampleData02 <- sampleData[match(colnames(otuMatrix), sampleData$ID),] # not needed for phyloseq
samplePhyseq <- sampleData02 %>% column_to_rownames("ID") %>% sample_data()
```

```{r}
taxaA1 <- taxa %>% select(Kingdom:Genus, Tag, ASV) %>% as.data.frame() %>% filter(Kingdom != "Spike")
rownames(taxaA1) <- taxaA1$ASV
taxaA1m <- as.matrix(taxaA1)
taxaPhyseq <- taxaA1m %>% tax_table()
```

```{r}
pscb <- phyloseq(otuPhyseq, taxaPhyseq, samplePhyseq)
```

```{r}
pt0 <- proc.time()
pscb_phylum <- tax_glom(pscb, taxrank = "Phylum")
pt1 <- proc.time()
```
Ok, Amy Willis was right. This is really slow. Probably time to wash the dishes.
Too slow, but speedyseq sped things up.

```{r}
pt0 <- proc.time()
divnet_phylum <- pscb_phylum %>% divnet()
pt1 <- proc.time()
pt1 - pt0
```

```{r}
save(pscb, pscb_phylum, file = "phyloseq_objects.RData")
```

```{r}
phyTaxa <- tax_table(pscb_phylum) %>% as("data.frame")
```

This didn't actually agglomerate
Run phyloseq version overnight
```{r}
pt0 <- proc.time()
pscb_phylum <- phyloseq::tax_glom(pscb, taxrank = "Phylum")
pt1 <- proc.time()
```

On cluster, had to biocmanager install Phyloseq,
then divnet

# I'm having some problems still so I'm making a less informative otu table

```{r}
PhyTaxOnly <- taxaPhyseq[,c("Kingdom", "Phylum")]
OTUAnon <- otuPhyseq
colnames(OTUAnon) <- paste0("Site_", 1:dim(otuPhyseq)[2])
```

Why are there a bunch of zeros in my OTU table?

```{r}
pscb2 <- filter_taxa(pscb, function(x){sum(x) >= 1}, prune = TRUE)
pscb2
```

Ok, this isn't going to change that much, but I should still figure out why the zeros. My guess is thes are singletons from like neg controls and mocks.
I still need to figure out why divnet can't handle the data.

```{r}
otu_table(pscb2) %>% tail() -> moo2 
```

