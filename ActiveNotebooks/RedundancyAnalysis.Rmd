---
title: "R Notebook"
output: html_notebook
---

Trying to be more systematic about constrained CCA.

Doing RDA instead of CCA to see what happens

I think I just need one RDA?

## Steps from before

Step 1 -- CCA with Station and Depth and Size

Step 2 -- CCA with Size, factoring out Station and Depth

Step 3 -- CCA with Size, factoring out Station and Depth, removing Free-living microbes

Step 4 - CCA with Size, factoring out Station and Depth, > 5 micron only

Try to get nice looking CCA plots with symbols on each

```{r}
library(ggvegan)
library(vegan)
library(tidyverse)
library(cowplot)
library(here)
library(flextable)
library(ftExtra)
#source(here("RScripts", "InitialProcessing_3.R"))
source(here("RLibraries", "ChesapeakePersonalLibrary.R"))
env1 <- attach(here("RDataFiles", "InitialProcessing_3_minimal.RData"))
set.seed(10033)
```

```{r}
nonSpikes20 <- env1$nonSpikes20
sampleData <- env1$sampleData
```


# Setup


```{r}
wideASVs <- nonSpikes20 %>%
  mutate(copiesPerLPermm = copiesPerL/Bin_Size) %>%
  #filter(Depth != "Oxy") %>%
  #mutate(copiesPerLPermm = copiesPerL/MassperLiter) %>% # temporary swap out just to see
  select(ID, ASV, copiesPerLPermm) %>%
  pivot_wider(id_cols = ID, names_from = ASV, values_from = copiesPerLPermm) %>%
  column_to_rownames("ID") %>% na.omit() 
```

```{r}
sampleData01 <- sampleData[match(rownames(wideASVs), sampleData$ID),]
```


```{r}
wideASVs_log <- log(wideASVs + 1)
wideASVs_scaled <- scale(wideASVs_log)
```

## Plot settings
```{r}
filterSizes <- c(0.2, 1.2, 5, 20, 53, 180, 500)
myGuides <-   guides(shape = guide_legend(ncol = 2), fill = guide_legend(ncol = 2),
         size = guide_legend(ncol = 2),
         color = guide_legend(ncol = 2))

myPlotDetails <- list(
  scale_fill_viridis_d() ,
  scale_shape_manual(values = rep(21:25, 2)),
  scale_color_manual(values = c("green", "blue", "black")) ,
  scale_size(breaks = sqrt(filterSizes),
             labels = filterSizes) ,
  theme_bw(),
  myGuides
)
```


# RDA with everything
but pretty this time

```{r}
rdaConstrained <- rda(wideASVs_log ~ lat + Depth2 + sqrt(Size_Class), data = sampleData01)
```

```{r}
rdaConstrained
anova(rdaConstrained)
```



```{r}
mooAnova <- anova(rdaConstrained, by = "margin", permutations = 9999)
mooAnova
mooAnova$Variance/sum(mooAnova$Variance) # proportions explained
sum(mooAnova$Variance[1:3])/sum(mooAnova$Variance) # same as total variance explained? Very similar
```
Lets make this into a nice table
Columns are variance?,  percent variance explained, F, P
And a row added for residual and for total


```{r}
# note that I'm using a non breaking space in the percent variance variable name
# unicode: 00a0
betaTable <- mooAnova %>% broom::tidy() %>%
  mutate(`% Variance` = Variance/sum(Variance)) %>%
  mutate(term = recode(term, lat = "Latitude", Depth2 = "Depth", `sqrt(Size_Class)` = "√Size Class")) %>%
  select(Term = term, DF = df, Variance, `% Variance`, T = statistic, p = p.value) %>%
    mutate(Variance = format(Variance, digits = 3),
         `% Variance` = format(`% Variance`, digits = 2),
         `T` = if_else(is.na(`T`), "", format(`T`, digits = 2)),
         p = if_else(p < 0.001, "< 0.001", paste0(" ", format(round(p, 3), digits = 1, scientific = FALSE)))
         ) %>%
  flextable() %>%
  align(j = -c(1), align = "right", part = "all") %>%
  bold(i = ~ p < 0.05, j = "p") %>%
  italic(j = "p", part = "header") %>%
  identity()

betaTable

betaTable %>% save_as_docx(path = here::here("Tables", "betaTable.docx"))
```

```{r}
CCA_Eigen_Plot <- function(CCA){
  CCAPctVarPlot <- enframe(c(CCA$CCA$eig/CCA$tot.chi,CCA$CA$eig/CCA$tot.chi), name = "CA", value = "PctVarExplained") %>%
  mutate(CAN = parse_number(CA)) %>%
    mutate(Type = str_remove(CA, "[:digit:].*")) %>%
    mutate(Type = factor(Type, levels = c("RDA", "PC"))) %>%
  ggplot(aes(x = CAN, y = PctVarExplained)) + 
  geom_point() +
  geom_segment(aes(x = CAN, xend = CAN, y = 0, yend = PctVarExplained)) + 
  labs(y = "Percent Variance Explained", x = NULL) +
   #geom_vline(xintercept = 7.5, color = "grey") +
    facet_grid(~Type, scales = "free_x", space = "free_x", switch = "both") + 
  scale_x_continuous(expand = c(0.1,0)) +
  theme_bw() +
  theme(strip.background = element_blank(),
           strip.placement = "outside", legend.position = "none")
CCAPctVarPlot
}

CCA_Eigen_Plot(rdaConstrained)
```
This looks pretty awful, but Its not going in the paper I don't think so I'll leave it for now.

```{r}
my_fortify_function <- function(ccaConstrained){
  fortify(ccaConstrained) %>% filter(Score %in% c("sites", "biplot")) %>% # not sure what constraints are
    left_join(microbialAbundance, by = c("Label" = "ID"))
}

my_percent_explained <- function(ccaConstrained){
  loc_anova <- anova(ccaConstrained, by = "margin")
  loc_props <- loc_anova$Variance/sum(loc_anova$Variance)
  loc_props_nr <- loc_props[1:(length(loc_props)-1)]
  loc_props_nr
}

My_Constrained_RDA_Plot_Type1 <- function(ccaConstrainedFort, ccaConstrained){
  ccaConstrainedPlot <- ccaConstrainedFort %>%
    filter(Score == "sites") %>%
    mutate(Depth = recode(Depth, `Oxy` = "Oxycline")) %>%
    select(Station, Depth, Size_Class, everything()) %>%
    ggplot(aes(x = RDA1, y = RDA2,
               fill = as.factor(Station),
               shape = as.factor(Station),
               size = sqrt(Size_Class),
               color = as.factor(Depth)
    )) + 
    geom_point() +
    coord_fixed(sqrt(ccaConstrained$CCA$eig[2]/ccaConstrained$CCA$eig[1])) +
    
    
    #geom_point(aes(x  = CCA1, y = CCA2), data = ccaConstrainedFort %>% filter(Score == "biplot"), inherit.aes = FALSE) +
    labs(x = paste0("RDA1 (", round(ccaConstrained$CCA$eig[1]/ccaConstrained$tot.chi, 3) * 100, "%)"),
         y = paste0("RDA2 (", round(ccaConstrained$CCA$eig[2]/ccaConstrained$tot.chi, 3) * 100, "%)"),
         col = "Depth (Outline Color)",
         fill = "Station",
         shape = "Station",
         size = "Size Class") +
        geom_segment(aes(x = 0, y = 0, xend  = RDA1 * 7, yend = RDA2 * 7), data = ccaConstrainedFort %>% filter(Score == "biplot"), inherit.aes = FALSE, size = 1, alpha = 0.9, arrow = arrow(length = unit(0.1, "in")), color = "gray20") +
    geom_label(aes(label = Label2, x = RDA1 * 9, y = RDA2 * 9),
               color = "black", fill = "white", alpha = 0.4,
               show.legend = FALSE,
               data = ccaConstrainedFort %>%
                 filter(Score == "biplot") %>%
                 mutate(Label = recode(Label, lat = "Lat",
                                       `sqrt(Size_Class)` = "Size",
                                       `Depth2Surface` = "Surface"
                 )) %>%
                 mutate(PctExplained = my_percent_explained(ccaConstrained)) %>%
                 mutate(Label2 = paste0(Label, "\n", round(PctExplained, 3) * 100, "%")) %>%
                 # Fates, please forgive me my hard-coding.
                 # I just need the biplot segment labels away from the origin.
                 mutate(RDA1 = if_else(sqrt(RDA1^2 + RDA2^2) < 0.5, RDA1 * 1.5, RDA1)) %>%
                 mutate(RDA2 = if_else(sqrt(RDA1^2 + RDA2^2) < 0.5, RDA2 * 1.5, RDA2)) %>%
                 identity()
    ) +

    lims(x = c(range(ccaConstrainedFort$RDA1)[1] * 1.1, range(ccaConstrainedFort$RDA1)[2] * 1.5), y = range(ccaConstrainedFort$RDA2 * 1.1)) +
    myPlotDetails +
    guides(color = guide_legend(override.aes = list(shape = 21, size = 2, stroke = 2, fill = "gray")),
           shape = guide_legend(override.aes = list(size = 3)),
           size = guide_legend(override.aes = list(shape = 21, color = "black", fill = "gray"), ncol = 2)
    )
  ccaConstrainedPlot
}

My_Constrained_RDA_Plot_Type1_wFort <- function(ccaConstrained){
  ccaConstrainedFort <- my_fortify_function(ccaConstrained)
  My_Constrained_RDA_Plot_Type1(ccaConstrainedFort, ccaConstrained)
}


mainRDA <- My_Constrained_RDA_Plot_Type1_wFort(rdaConstrained)
mainRDA
```

```{r}
ggsave(here::here("Figures", "mainRDA.png"),mainRDA, height = 4.4, width = 6)
```


Axis 1 vs 3
Not the most dry code I've ever done, but I'm not sure how to actually do this, so I'm manually changing the axes
```{r}
My_Constrained_RDA_Plot_Type1_13 <- function(ccaConstrainedFort, ccaConstrained){
  ccaConstrainedPlot <- ccaConstrainedFort %>%
  filter(Score == "sites") %>%
  mutate(Depth = recode(Depth, `Oxy` = "Oxycline")) %>%
  select(Station, Depth, Size_Class, everything()) %>%
  ggplot(aes(x = RDA1, y = RDA3,
             fill = as.factor(Station),
             shape = as.factor(Station),
             size = sqrt(Size_Class),
             color = as.factor(Depth)
             )) + 
 geom_point() +
 coord_fixed(sqrt(ccaConstrained$CCA$eig[2]/ccaConstrained$CCA$eig[1])) +

  geom_segment(aes(x = 0, y = 0, xend  = RDA1 * 7, yend = RDA3 * 7), data = ccaConstrainedFort %>% filter(Score == "biplot"), inherit.aes = FALSE, size = 1, alpha = 0.9, arrow = arrow(length = unit(0.1, "in")), color = "gray20") +
  #geom_point(aes(x  = CCA1, y = CCA2), data = ccaConstrainedFort %>% filter(Score == "biplot"), inherit.aes = FALSE) +
    labs(x = paste0("RDA1 (", round(ccaConstrained$CCA$eig[1]/ccaConstrained$tot.chi, 3) * 100, "%)"),
       y = paste0("RDA3 (", round(ccaConstrained$CCA$eig[3]/ccaConstrained$tot.chi, 3) * 100, "%)"),
       col = "Depth (Outline Color)",
       fill = "Station",
       shape = "Station",
       size = "Size Class") +
     geom_label(aes(label = Label2, x = RDA1 * 9, y = RDA3 * 9),
            color = "black", fill = "white", alpha = 0.6,
            show.legend = FALSE,
           data = ccaConstrainedFort %>%
             filter(Score == "biplot") %>%
             mutate(Label = recode(Label, lat = "Lat",
                                   `sqrt(Size_Class)` = "Size",
                                   `Depth2Surface` = "Surface"
                                   )) %>%
             mutate(PctExplained = my_percent_explained(ccaConstrained)) %>%
             mutate(Label2 = paste0(Label, "\n", round(PctExplained, 3) * 100, "%"))
             ) +
    lims(x = c(range(ccaConstrainedFort$RDA1)[1] * 1.1, range(ccaConstrainedFort$RDA1)[2] * 1.5), y = range(ccaConstrainedFort$RDA3 * 1.1)) +
  myPlotDetails +
  guides(color = guide_legend(override.aes = list(shape = 21, size = 2, stroke = 2, fill = "gray")),
         shape = guide_legend(override.aes = list(size = 3)),
         size = guide_legend(override.aes = list(shape = 21, color = "black", fill = "gray"))
         )
ccaConstrainedPlot
}

My_Constrained_RDA_Plot_Type1_wFort_13 <- function(ccaConstrained){
  ccaConstrainedFort <- my_fortify_function(ccaConstrained)
  My_Constrained_RDA_Plot_Type1_13(ccaConstrainedFort, ccaConstrained)
}
  

mainRDA13 <- My_Constrained_RDA_Plot_Type1_wFort_13(rdaConstrained)
mainRDA13
```

```{r}
ggsave(here::here("Figures", "mainRDA_axis1and3.png"),mainRDA13, height = 4, width = 6)
```


```{r}
rdaConstrainedFort <- fortify(rdaConstrained) %>% filter(Score %in% c("sites", "biplot")) %>% # not sure what constraints are
 left_join(microbialAbundance, by = c("Label" = "ID"))
```


# As above, but this time without the 0.2 micron data
```{r}
sampleData_NoFree <- sampleData01 %>% filter(Size_Class > 1)
wideASVs_log_NoFree <- wideASVs_log[rownames(wideASVs_log) %in% sampleData_NoFree$ID,]
wideASVs_log_NoFree <- wideASVs_log_NoFree[match(sampleData_NoFree$ID, rownames(wideASVs_log_NoFree)),]
```

```{r}
rdaConstrained_NoFree <- rda(wideASVs_log_NoFree ~ lat + Depth2 + sqrt(Size_Class), data = sampleData_NoFree)
```

```{r}
rdaConstrained_NoFree
anovaNofree <- anova(rdaConstrained_NoFree, by = "margin", permutations = how(nperm=9999))
anovaNofree
```
```{r}
plotNoFreeRda <- My_Constrained_RDA_Plot_Type1_wFort(rdaConstrained_NoFree)

plotNoFreeRda
```




# As above but without 0.2 or 1.2 micron data

```{r}
sampleData_NoSmall <- sampleData01 %>% filter(Size_Class > 2)
wideASVs_log_NoSmall <- wideASVs_log[rownames(wideASVs_log) %in% sampleData_NoSmall$ID,]
wideASVs_log_NoSmall <- wideASVs_log_NoSmall[match(sampleData_NoSmall$ID, rownames(wideASVs_log_NoSmall)),]
```

```{r}
rdaConstrained_NoSmall <- rda(wideASVs_log_NoSmall ~ lat + Depth2 + sqrt(Size_Class), data = sampleData_NoSmall)
```

```{r}
rdaConstrained_NoSmall
anovaNoSmall <- anova(rdaConstrained_NoSmall, by = "margin", permutations = how(nperm=9999))
anovaNoSmall
```
```{r}
plotNoSmallRda<- My_Constrained_RDA_Plot_Type1_wFort(rdaConstrained_NoSmall) + lims(x = c(-10, 11))
plotNoSmallRda
```
Cowplot the last two together so they can be one supplemental figure

```{r fig.width = 7, fig.height = 8}
legend_rda <- get_legend(
  plotNoFreeRda + theme(legend.box.margin = margin(0, 0, 0, 0))
                         )

bigSubsetsRda0 <- plot_grid(plotNoFreeRda + theme(legend.position = "none"),
                           plotNoSmallRda + theme(legend.position = "none"),
                           labels = LETTERS, nrow = 2)
bigSubsetsRda <- plot_grid(bigSubsetsRda0, legend_rda, rel_widths = c(10, 1))
bigSubsetsRda
```
```{r}
ggsave(here::here("Figures", "bigSubsetsRda.png"), bigSubsetsRda, height = 8, width = 7)
```

# Tables

```{r}
threeAnovas <- bind_rows(
mooAnova %>% broom::tidy() %>% mutate(dataset = "All"),
anovaNofree %>% broom::tidy() %>% mutate(dataset = "Particle Associated"),
anovaNoSmall %>% broom::tidy() %>% mutate(dataset = "≥ 5 Micron Particles")
) %>%
  select(Dataset = dataset, everything())

betaThreeTable <- threeAnovas %>%
  #mutate(`% Variance` = paste0(round(Variance/sum(Variance) * 100, 1), "%")) %>%
  mutate(`% Variance` = scales::percent(Variance/sum(Variance), accuracy = 0.1)) %>%
  
  mutate(term = recode(term, lat = "Latitude", Depth2 = "Depth", `sqrt(Size_Class)` = "√Size Class")) %>%
  select(Dataset, Term = term, DF = df, Variance, `% Variance`, T = statistic, p = p.value) %>%
    mutate(Variance = format(Variance, digits = 3),
         `% Variance` = format(`% Variance`, digits = 2),
         `T` = if_else(is.na(`T`), "", format(`T`, digits = 2)),
         p = if_else(p < 0.001, "< 0.001", paste0(" ", format(round(p, 3), digits = 1, scientific = FALSE)))
         ) %>%
  flextable() %>%
  align(j = -c(1), align = "right", part = "all") %>%
  bold(i = ~ p < 0.05, j = "p") %>%
  italic(j = "p", part = "header") %>%
  merge_v(j = "Dataset") %>%
  theme_vanilla() %>%
  identity()

betaThreeTable %>% save_as_docx(path = here::here("Tables", "betaThreeTable.docx"))
betaThreeTable
```

# Comparing to environmental parameters

```{r}
rdaConstrained_env <- rda(wideASVs_log ~ Salinity + Depth2 + sqrt(Size_Class), data = sampleData01)
```

```{r}
anova(rdaConstrained_env, by = "margin")
```

```{r}
My_Constrained_RDA_Plot_Type1_wFort(rdaConstrained_env)
```
```{r}
rdaConstrained_wdepth <- rda(wideASVs_log ~ Salinity + Depth_m  + log(Oxygen + 0.03) + sqrt(Size_Class), data = sampleData01)
anova(rdaConstrained_wdepth, by = "margin")
```


```{r}
rdaConstrained_env2 <- rda(wideASVs_log ~ Salinity  + Oxygen + sqrt(Size_Class), data = sampleData01 %>% mutate(Oxygen = log(Oxygen + 0.03)))
anova(rdaConstrained_env2, by = "margin")
```
```{r}
EnvRDA <- My_Constrained_RDA_Plot_Type1_wFort(rdaConstrained_env2)
EnvRDA
My_Constrained_RDA_Plot_Type1_wFort_13(rdaConstrained_env2)
```

```{r fig.height = 4, fig.width = 8}
combinedRDA <- plot_grid( mainRDA + theme(legend.position = "none"), 
           EnvRDA + theme(legend.position = "none"),
           legend_rda, rel_widths = c(3,3,1), nrow = 1, labels = c("A", "B", ""), label_y = 0.9)
combinedRDA
```


sampleData_NoSmall <- sampleData01 %>% filter(Size_Class > 2)
wideASVs_log_NoSmall <- wideASVs_log[rownames(wideASVs_log) %in% sampleData_NoSmall$ID,]
wideASVs_log_NoSmall <- wideASVs_log_NoSmall[match(sampleData_NoSmall$ID, rownames(wideASVs_log_NoSmall)),]

Particle characteristics?
Have to strike the 0.2 and omit any missing values.
```{r}
sampleData_MeasuredParticles <- sampleData01 %>%
  filter(!is.na(CarbonPerLiter_mg) & !is.na(MassperLiter))
wideASVs_log_MeasuredParticles <- wideASVs_log[match(sampleData_MeasuredParticles$ID, rownames(wideASVs_log)),]
```


```{r}
rdaConstrained_env_particles <- rda(wideASVs_log_MeasuredParticles ~ Salinity  + log(Oxygen + 0.03) + sqrt(Size_Class) + I(CarbonPerLiter_mg/MassperLiter) + I(NitrogenPerLiter_mg/CarbonPerLiter_mg) + `δ13CVPDB (‰)` + `δ15NAir (‰)`, data = sampleData_MeasuredParticles)
```

```{r}
anova(rdaConstrained_env_particles, by = "margin")
```
```{r}
ordistep(rdaConstrained_env2)
```
# Squared terms


```{r}
rdaConstrained_env3 <- rda(wideASVs_log ~ Salinity + I(Salinity^2)  + Oxygen + Size + I(Size^2), data = sampleData01 %>%
                             mutate(Oxygen = log(Oxygen + 0.03),
                                    Size = sqrt(Size_Class)))
anova(rdaConstrained_env3, by = "margin")
```
```{r}
rdaConstrained_position <- rda(wideASVs_log ~ Latitude + I(Latitude^2) + Depth + Size + I(Size^2), data = sampleData01 %>%
                        select(-Depth) %>%
                        rename(Latitude = lat, Depth = Depth2) %>%
                        mutate(Size = sqrt(Size_Class)))
anova(rdaConstrained_position, by = "margin")
```

```{r}
rdaConstrained
rdaConstrained_position
rdaConstrained_env2
rdaConstrained_env3
```
```{r}
rdaConstrained %>% extractAIC()
rdaConstrained_position %>% extractAIC()
rdaConstrained_env2 %>% extractAIC()
rdaConstrained_env3 %>% extractAIC()
```

```{r}
positionRDA_Quadratic <- My_Constrained_RDA_Plot_Type1_wFort(rdaConstrained_position)
envRDA_Quadratic <- My_Constrained_RDA_Plot_Type1_wFort(rdaConstrained_env3)
positionRDA_Quadratic
envRDA_Quadratic
```

```{r}
My_Constrained_RDA_Plot_Type1_wFort_13(rdaConstrained_position)
```
```{r}
plot(rdaConstrained_position, choices = c(1,6))
```

