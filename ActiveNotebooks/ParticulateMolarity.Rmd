---
title: "R Notebook"
output: html_notebook
---

2022 November 18
Jacob Cram

We just got data back from UC dafvis of carbon and nitrogne content of particles.
This file is for examining that data

```{r}
library(tidyverse)
library(here)
library(readxl)
library(cowplot)
library(grid)
library(gridExtra)

#source(here::here("RScripts","ElementalAnalysis.R"))
load(here::here("RDataFiles", "microbialAbundance.RData"))
my_sizes <- sort(unique(microbialAbundance$Size_Class))
source(here::here("RLibraries", "ChesapeakePersonalLibrary.R"))

```



I'm not subtracting blanks for now (on account of they are pretty small)
```{r}
ches_plot_options2 <- list(
  #scale_y_log10nice() ,
  scale_x_log10(breaks = my_sizes, labels = as.character(my_sizes)) ,
  geom_point(size = 2) ,
  geom_path(aes(color = as.factor(Station))) ,
  scale_shape_manual(values = rep(21:25, 2)) ,
  scale_fill_viridis_d(option = "plasma") ,
  scale_color_viridis_d(option = "plasma")
)

cb_plotter <- function(Variable, logify = TRUE, lab){
  EVariable <- enquo(Variable)
  
  plt0 <- microbialAbundance %>%
    #filter(Type == "Sample") %>%
    filter(!is.na(Station)) %>%
    arrange(Size_Class) %>%
    filter(Size_Class != 0.2) %>%
    #filter(Depth != "Oxy") %>%
    ggplot(aes(y = !!EVariable, x = Size_Class, shape = as.factor(Station), fill = as.factor(Station))) +
    geom_point() +
    facet_wrap(~as.factor(Depth), ncol = 1) +
    ches_plot_options2 +
    theme_bw(base_size = 14) +
    theme(legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_text(angle = 90)) +
    labs(y = lab)
  
  if(logify){
    plt1 <- plt0 + scale_y_log10nice()
  }else{
    plt1 <- plt0
  }
  
  plt1
}
cb_plotter(CarbonPerLiter_mg/Bin_Size, logify = TRUE, lab = "POC (μM/mm)")
```
```{r}
cb_plotter(MassperLiter/Bin_Size, logify = TRUE, lab = "Particle Mass (mg/L/mm)")
# cb_plotter(ParticlesPerLiter/Bin_Size, logify = TRUE, lab = "Particle Abundance (#/L/mm)") -- This has been linearalized at some point. Not buying it.
cb_plotter(CarbonPerLiter_mg/Bin_Size, logify = TRUE, lab = "POC (mg/L/mm)")
cb_plotter(NitrogenPerLiter_mg/Bin_Size, logify = TRUE, lab = "PON (mg/L/mm)")
cb_plotter(CarbonPerLiter_mg/MassperLiter, logify = FALSE, lab = "POC/Mass") + scale_y_log10()
cb_plotter(NitrogenPerLiter_mg/MassperLiter, logify = FALSE, lab = "PON/Mass") + scale_y_log10()
cb_plotter(CarbonPerLiter_mg/NitrogenPerLiter_mg, logify = FALSE, lab = "POC/PON") + geom_hline(yintercept = 106/16)  + scale_y_log10()
cb_plotter(`δ13CVPDB (‰)`, logify = FALSE, lab = "δ13C (‰)")
cb_plotter(`δ15NAir (‰)`, logify = FALSE, lab = "δ15N (‰)")
```

I think I want three plots -- all will be supplementary probably

Fig SX: Mass, moles C, moles N
Fig SX + 1: C/mass, N/mass, C:N
Fig SX + 2: delta 13c and delta 15n

Fig SX: Mass, moles C, moles N

x.grob <- textGrob(expression(paste("Particle Size (", mu, "m)")), 
                   gp=gpar(fontsize=14))

combinedPlot <- plot_grid(abunPlot_perL, abunPlot_perMg, nrow = 1, labels = c("B", "C"))
combinedPlot_xg <- grid.arrange(arrangeGrob(combinedPlot, x.grob, heights = c(10, 1)))

Function to add a common x label

```{r}
append_xg <- function(plt, txt = expression(paste("Particle Size (", mu, "m)"))){
  x.grob0 <- textGrob(expression(paste("Particle Size (", mu, "m)")), 
                   gp=gpar(fontsize=14))
  plot_xg <- grid.arrange(arrangeGrob(plt, x.grob0, heights = c(10, 1)))
}

```



```{r}
molarityPlot0 <- plot_grid(
  cb_plotter(MassperLiter/Bin_Size, logify = TRUE, lab = "Particle Mass (mg/L/mm)"),
  cb_plotter(CarbonPerLiter_mg/Bin_Size, logify = TRUE, lab = "POC (mg/L/mm)"),
  cb_plotter(NitrogenPerLiter_mg/Bin_Size, logify = TRUE, lab = "PON (mg/L/mm)"),
  nrow = 1,
  labels = LETTERS
)

molarityPlot <- append_xg(molarityPlot0)
ggsave(here::here("Figures", "MCN_Molarity.png"), plot = molarityPlot, height = 4, width = 6)
```

```{r}
ratioPlot <- plot_grid(
  cb_plotter(CarbonPerLiter_mg/MassperLiter, logify = TRUE, lab = "POC/Mass") + scale_y_log10(),
  cb_plotter(NitrogenPerLiter_mg/MassperLiter, logify = TRUE, lab = "PON/Mass") + scale_y_log10(),
  cb_plotter(CarbonPerLiter_mg/NitrogenPerLiter_mg, logify = TRUE, lab = "POC/PON") + scale_y_log10() + geom_hline(yintercept = 106/16),
  nrow = 1,
  labels = LETTERS
) %>% append_xg()
ggsave(here::here("Figures", "MCN_Ratios.png"), plot = ratioPlot, height = 4, width = 6)
```
C:N Cite Van Mooy

```{r}
deltaCNPlot <- plot_grid(
  cb_plotter(`δ13CVPDB (‰)`, logify = FALSE, lab = bquote(`δ`^{13}*'C (‰)')),
  cb_plotter(`δ15NAir (‰)`, logify = FALSE, lab = bquote(`δ`^{15}*'N (‰)')),
  nrow = 1,
  labels = LETTERS
) %>% append_xg()
ggsave(here::here("Figures", "CN_IsotopeRatios.png"), plot = deltaCNPlot, height = 4, width = 4)
```
Clara says 40 delta 15N is very very high.


# Primary figure
Happens over in ActiveNotebooks/AllMicrobesFigures.qmd