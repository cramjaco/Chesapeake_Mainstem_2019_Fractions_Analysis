---
title: "ManuscriptFigures"
author: "Jacob Cram"
format: html
editor: visual
---

# Initial Stuff

```{r}
library(tidyverse)
library(here)
library(grid)
library(gridExtra)
library(cowplot)
```

Load in Initial Processing file (and dependencies)

```{r}
#source(here::here("RScripts", "InitialProcessing_3.R"))

load(here::here("RDataFiles", "InitialProcessing_3_minimal.RData"))

#my_sizes <- sort(unique(microbialAbundance$Size_Class))

source(here::here("RLibraries", "ChesapeakePersonalLibrary.R"))

ksource(here::here("ActiveNotebooks", "ParticulateMolarity.Rmd"))
```

# Example

Show how one species can be described differently with normalizations

# Total microbes Abundance

## Map

```{r}
source(here("RScripts", "CBMap_Transect.R"))
```

```{r}
cbMap
```

## Microbes per mg particle

```{r}
abunPlot_perMg <- microbialAbundance %>% 
  filter(is.finite(MassperLiter)) %>%
  #filter(Depth %in% c("Surface", "Bottom")) %>%
  mutate(copiesPerMg = copiesPerL / MassperLiter) %>%
  ggplot(aes(x = Size_Class, y = copiesPerMg, shape = as.factor(Station), fill = as.factor(Station))) +
  facet_wrap(~Depth, ncol = 1) +
  ches_plot_options  +
theme_bw(base_size = 14) +

   labs(y = "16S + 18S Genes / mg Particles", x = expression(paste("Particle Size (", mu, "m)")))+
  theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(2, 2, 2, 2), "mm"), vjust = 0))
abunPlot_perMg
```

## Microbes per L of water?

```{r}
abunPlot_perL <- microbialAbundance %>% 
  #filter(is.finite(MassperLiter)) %>%
  #filter(Depth %in% c("Surface", "Bottom")) %>%
  mutate(copiesPerMg = copiesPerL/Bin_Size) %>% # Bad leftover variable name
  ggplot(aes(x = Size_Class, y = copiesPerMg, shape = as.factor(Station), fill = as.factor(Station))) +
  facet_wrap(~Depth, ncol = 1) +
  ches_plot_options  +
  scale_y_log10nice(omag = seq(from = 3, to = 11, by = 2)) +
theme_bw(base_size = 14) +

   labs(y = "16S + 18S Genes/L/μm", x = expression(paste("Particle Size (", mu, "m)")))+
  theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(2, 2, 2, 2), "mm"), vjust = 0))
abunPlot_perL
```

## Compound figure

```{r}
x.grob <- textGrob(expression(paste("Particle Size (", mu, "m)")), 
                   gp=gpar(fontsize=14))

combinedPlot <- plot_grid(abunPlot_perL, abunPlot_perMg, nrow = 1, labels = c("B", "C"))
combinedPlot_xg <- grid.arrange(arrangeGrob(combinedPlot, x.grob, heights = c(10, 1)))
```

```{r fig.height=3, fig.width = 6}
TotalAbundanceFigure <- plot_grid(cbMap, combinedPlot_xg, rel_widths = c(1,2.5), labels = c("A", ""))
TotalAbundanceFigure
```

```{r}
ggsave(here::here("Figures", "TotalAbundanceFigure.png"), height = 4, width = 6)
```

# As above but with elements

Lettered A-D

```{r fig.height=6, fig.width = 11}
combinedPlot2a <- plot_grid(
  cb_plotter(MassperLiter/Bin_Size, logify = TRUE, lab = "Particle Mass (mg/L/μm)") +
    theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(2, 2, 2, 2), "mm"), vjust = 0)), # total particle mass
  cb_plotter(CarbonPerLiter_mg/MassperLiter, logify = TRUE, lab = "POC/Mass") + scale_y_log10() +
    theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(2, 2, 2, 2), "mm"), vjust = 0)), # mg carbon per mg particle (unitless)
  
  abunPlot_perL, abunPlot_perMg, # bacteria
                          
                          nrow = 1, labels = LETTERS[1:5]) %>% append_xg()
combinedPlot2a
```

```{r fig.height=6, fig.width = 11}
combinedPlot2 <- plot_grid(
  cb_plotter(MassperLiter/Bin_Size, logify = TRUE, lab = "Particle Mass (mg/L/μm)") +
    theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(2, 2, 2, 2), "mm"), vjust = 0)), # total particle mass
  cb_plotter(CarbonPerLiter_mg/MassperLiter, logify = TRUE, lab = "POC/Mass") + scale_y_log10() +
    theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(2, 2, 2, 2), "mm"), vjust = 0)), # mg carbon per mg particle (unitless)
  
  abunPlot_perL, abunPlot_perMg, # bacteria
                          
                          nrow = 1, labels = LETTERS[2:5]) %>% append_xg()
combinedPlot2
```

```{r fig.height=4, fig.width = 10}
TotalMassAbundanceFigure <- plot_grid(cbMap, combinedPlot2, rel_widths = c(2.5,10), labels = c("A", ""))
TotalMassAbundanceFigure

```

```{r}
ggsave(here::here("Figures", "MassAndAbundanceNoMap.png"), height = 4, width = 8 ,plot = combinedPlot2a)
ggsave(here::here("Figures", "MassAndAbundanceFigure.png"), height = 4, width = 10 ,plot = TotalMassAbundanceFigure)
```

## 

## Queries

### Carbon vs mass samples

I wonder if we have more carbon isotope or more mass samples. I should check this in the interest of using as much data as possible for the microbes/mg particles and brigandine fugures.

```{r}
microbialAbundance %>%
  summarize(nCarbon = sum(is.finite(CarbonPerLiter_mg)),
            nMass = sum(is.finite(MassperLiter)))
```

There are more mass samples so I'll use those.

### Fraction of particle attached miccrobes in smallest size fraction

```{r}
maSmallFrac <- microbialAbundance %>%
  filter(Size_Class >= 1.2) %>%
  #filter(!is.na(copiesPerL)) %>%
  mutate(Size_Class_Type = if_else(Size_Class > 1.2, "> 1.2", "1.2"), .after = Size_Class) %>%
  group_by(Station, Depth, Size_Class_Type) %>%
  summarise(copiesPerL = sum((copiesPerL))) %>%
  pivot_wider(names_from = Size_Class_Type, values_from = copiesPerL) %>%
  mutate(Frac1p2 = `1.2`/ (`> 1.2` + `1.2`)) %>%
  identity()

maSmallFrac %>%
  filter(!is.na(Frac1p2)) %>%
  ungroup() %>%
  summarise(median(Frac1p2), min(Frac1p2), max(Frac1p2))
```

Note that this is when counting unobserved size classes \> 1.2 microns as zeros.
