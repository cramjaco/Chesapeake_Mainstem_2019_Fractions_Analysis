---
title: "R Notebook"
output: html_notebook
---

```{r}
source("InitialProcessing.R")
```

```{r}
library(vegan)
```

```{r}
source("ChesapeakePersonalLibrary.R")
```


This file is dedicated to conventional, non div-net/breakaway stats, since breakaway seems to choke on this data.

Reshape back into an ASV matrix, but this time correcting for total abundance
```{r}
nonSpikes %>% head
```

```{r}
raDf <- nonSpikes %>% pivot_wider(id_cols = ID, names_from = ASV, values_from = RA, values_fill = 0)
raMat <- raDf %>% column_to_rownames("ID")
```

```{r}
raMat1 <- raMat %>% as.matrix()
```

```{r}
countMat <-  nonSpikes %>%
  pivot_wider(id_cols = ID, names_from = ASV, values_from = reads, values_fill = 0) %>%
  column_to_rownames("ID") %>% as.matrix()
```

```{r}
seqDep <- countMat %>% apply(1, sum)
min(seqDep)
```

```{r}
sampleRichness <- rarefy(countMat, min(seqDep))
```

```{r}
countRare <- rrarefy(countMat, min(seqDep))
```

Gamma diversity
```{r}
specpool(countRare)
```

# Doesn't finish

```{r}
#specpool(countMat)
```


```{r}
richnessRare <- estimateR(countRare)
```

```{r}
shan <- diversity(countRare)
shan
```

```{r}
pielouJ <- shan/richnessRare["S.chao1",]
pielouJ
```

```{r}
shan %>% enframe(name = "ID", value = "shannonH")
```


```{r}
diversityData <- sampleData %>% 
  left_join(richnessRare %>% t() %>% as.data.frame() %>% rownames_to_column("ID"), by = "ID") %>%
  left_join(shan %>% enframe(name = "ID", value = "shannonH"), by = "ID") %>%
  left_join(pielouJ %>% enframe(name = "ID", value = "pielouJ"), by = "ID") %>%
  arrange(Size_Class)
```

```{r}
plotSpecs <- list(
  facet_wrap(~Depth, ncol = 1) ,
  theme_bw(base_size = 16) ,
  geom_point(size = 4) ,
  geom_path(aes(color = as.factor(Station))) ,
  scale_x_log10(breaks = my_sizes, labels = as.character(my_sizes)) ,
  #scale_y_log10nice() ,
  scale_shape_manual(values = rep(21:25, 2)) ,
  scale_fill_viridis_d(option = "plasma") ,
  scale_color_viridis_d(option = "plasma") ,
  labs(x = expression(paste("Particle Size (", mu, "m)"))) ,
  theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(0, 0, 0, 0), "mm"), vjust = 0))
)
```

```{r}
diversityData %>%
filter(Depth %in% c("Surface", "Bottom")) %>%
  ggplot(aes(x = Size_Class, y = S.obs, shape = as.factor(Station), fill = as.factor(Station))) +
  plotSpecs + scale_y_log10()
```

```{r}
diversityData %>%
filter(Depth %in% c("Surface", "Bottom")) %>%
  ggplot(aes(x = Size_Class, y = S.chao1, shape = as.factor(Station), fill = as.factor(Station))) +
  plotSpecs + scale_y_log10() +
  geom_errorbar(aes(ymin = S.chao1 -2 * se.chao1, ymax = S.chao1 + 2* se.chao1), width = -.1)
```



```{r}
diversityData %>%
filter(Depth %in% c("Surface", "Bottom")) %>%
  ggplot(aes(x = Size_Class, y = shannonH, shape = as.factor(Station), fill = as.factor(Station))) +
  plotSpecs
```


```{r}
diversityData %>%

filter(Depth %in% c("Surface", "Bottom")) %>%
  ggplot(aes(x = Size_Class, y = pielouJ, shape = as.factor(Station), fill = as.factor(Station))) +
  plotSpecs + scale_y_log10()
```
Ok, evenness looks like a mess,and maybe I trust shannon more than these non div-net diversity values. Do we see trends with lat and size?
```{r}
shanMod <- lm(shannonH ~ log(Size_Class) + I(log(Size_Class)^2) + lat + I(lat^2) + depth, data = diversityData)
```


```{r}
summary(shanMod)
```
```{r}
shanModSimple <- lm(shannonH ~ log(Size_Class) + I(log(Size_Class)^2), data = diversityData)
summary(shanModSimple)
```

```{r}
chao1Mod <- lm(S.chao1 ~ log(Size_Class) + I(log(Size_Class)^2) + I(log(Size_Class)^2) + lat + I(lat^2) + depth, data = diversityData)
summary(chao1Mod)
```

```{r}
chao1ModSimple <- lm(S.chao1 ~ log(Size_Class) + I(log(Size_Class)^2), data = diversityData)
summary(chao1ModSimple)
```

```{r}
pielouMod <- lm(pielouJ ~ log(Size_Class) + I(log(Size_Class)^2) + lat + I(lat^2) + depth, data = diversityData)
summary(pielouMod)
```

uomisto H (2010a). “A diversity of beta diver-
sities: straightening up a concept gone awry. 1.
Defining beta diversity as a function of alpha and
gamma diversity.” Ecography, 33, 2–2