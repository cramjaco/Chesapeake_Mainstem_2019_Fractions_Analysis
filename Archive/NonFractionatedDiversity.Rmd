---
title: "R Notebook"
output: html_notebook
---

```{r}
library(vegan)
library(tidyverse)
library(here)
source(here::here("RLibraries", "ChesapeakePersonalLibrary.R"))
```

```{r}
env1 <- load(here::here("RDataFiles", "InitialProcessing_3.RData"))
```

```{r}
countMat <-  nonSpikes %>%
  pivot_wider(id_cols = ID, names_from = ASV, values_from = reads, values_fill = 0) %>%
  column_to_rownames("ID") %>% as.matrix()
```


```{r}
seqDep <- countMat %>% apply(1, sum)
min(seqDep)
```

```{r}
bulkSample <- nonSpikes %>% 
  select(ASV, Station, Depth, Size_Class, copiesPerL) %>%
  group_by(Station, Depth, ASV) %>%
  summarise(copiesPerL = sum(copiesPerL), .groups = "keep")
bulkSample
```
```{r}
copies_to_ra <- function(vec){
  vsum <- sum(vec)
  vec/vsum
}

bulkSample01 <- bulkSample %>%
  group_by(Station, Depth) %>%
  mutate(RA = copies_to_ra(copiesPerL))
bulkSample01
```


```{r}
bulkSample01 %>% 
  group_by(Station, Depth) %>%
  summarise(totalCopies = sum(copiesPerL), totalRA = sum(RA))
```
Great, working.

```{r}
test_vecRA <- bulkSample01 %>% filter(Station == 4.3, Depth == "Surface") %>% pull(RA)
# vecRA is a vector of relative abundnaces
chao_from_ra <- function(vecRA, readdepth = 852, niter = 100){
  loc_counts <- rmultinom(n = niter, size = readdepth, prob = vecRA)
  moo <- apply(loc_counts, 2, estimateR)
  return(list(
    mean = mean(moo["S.chao1",]),
    sd = sd(moo["S.chao1",])
  ))
}

chao_from_ra(test_vecRA)
```

```{r}
bulkChao <- bulkSample01 %>%
  group_by(Station, Depth) %>%
  summarise(chao = chao_from_ra(RA, readdepth = 852)$mean, sd = chao_from_ra(RA)$sd)
bulkChao
```

```{r}
bulkChao <- nonSpikes %>% 
  select(ASV, Station, Depth, Size_Class, copiesPerL) %>%
  group_by(Station, Depth, ASV) %>%
  summarise(copiesPerL = sum(copiesPerL), .groups = "keep") %>%
  group_by(Station, Depth) %>%
  mutate(RA = copies_to_ra(copiesPerL)) %>%
  group_by(Station, Depth) %>%
  summarise(chao = chao_from_ra(RA, readdepth = 852)$mean, sd = chao_from_ra(RA)$sd)
```
```{r}
particlesChao <- nonSpikes %>% 
  select(ASV, Station, Depth, Size_Class, copiesPerL) %>%
  filter(Size_Class >= 1.2) %>%
  group_by(Station, Depth, ASV) %>%
  summarise(copiesPerL = sum(copiesPerL), .groups = "keep") %>%
  group_by(Station, Depth) %>%
  mutate(RA = copies_to_ra(copiesPerL)) %>%
  #group_by(Station, Depth) %>%
  summarise(chao = chao_from_ra(RA, readdepth = 852)$mean, sd = chao_from_ra(RA)$sd)
particlesChao
```

And now everything

```{r}
everythingChao <- nonSpikes %>% 
  select(ASV, Station, Depth, Size_Class, copiesPerL) %>%
  group_by(Station, Depth, Size_Class, ASV) %>%
  summarise(copiesPerL = sum(copiesPerL), .groups = "keep") %>%
  group_by(Station, Depth, Size_Class) %>%
  mutate(RA = copies_to_ra(copiesPerL)) %>%
  summarise(chao = chao_from_ra(RA, readdepth = 852)$mean, sd = chao_from_ra(RA)$sd)
```
```{r}
metaChao <- bind_rows(
  bulkChao %>% mutate(Size_Class = "> 0.2"),
  particlesChao %>% mutate(Size_Class = "> 1.2"),
  everythingChao %>% mutate(Size_Class = as.character(Size_Class))
) %>%
  mutate(Size_Class = ordered(Size_Class,
                              levels = c("> 0.2", "> 1.2",
                                         "0.2", "1.2", "5", "20", "53", "180", "500")))
metaChao
```
```{r}
plotSpecs1 <- list(
  #facet_wrap(~Depth, ncol = 1) ,
  theme_bw(base_size = 16) ,
  geom_point(size = 4) ,
  #geom_path(aes(color = as.factor(Station))) ,
  #scale_x_log10(breaks = my_sizes, labels = as.character(my_sizes)) ,
  #scale_y_log10nice() ,
  scale_shape_manual(values = rep(21:25, 2)) ,
  scale_fill_viridis_d(option = "plasma") ,
  scale_color_viridis_d(option = "plasma") ,
  labs(x = expression(paste("Particle Size (", mu, "m)"))) ,
  theme(legend.position = "none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .5),
        axis.title.y = element_text(margin = unit(c(3, 3, 3, 3), "mm"), vjust = 0))
)
```

```{r}
plotMetaChao <- metaChao %>%
  ungroup() %>%
filter(Depth %in% c("Surface", "Bottom")) %>%
  ggplot(aes(x = Size_Class, y = chao, shape = as.factor(Station), fill = as.factor(Station))) +
  plotSpecs1 +ylab("Richness (Chao1)") + #scale_y_log10() +
  geom_path(aes(color = as.factor(Station))) +
  facet_grid(Depth ~ Station)
plotMetaChao
```

I'm not sure what to make of this.
Clearly, there is some influence on diversity when a sample isn't collected. Eg the yellow station is probably affected by not being measured at 1.2 microns.
Diversity is more variable between samples than we would see if things were lumped.
Diversity can't really be higher in some fractions than others, but it is here because we have limited depth of sampling.\

I ought to toss the depth, size combinations that don't have all of the samples for this analysis.

